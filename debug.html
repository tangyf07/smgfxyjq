<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®ºå›è¿æ¥è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: sans-serif; padding: 40px; background: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 10px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; }
        .step { margin: 15px 0; padding: 10px; background: #eee; border-radius: 5px; display: flex; align-items: center; justify-content: space-between; }
        .step.pending { border-left: 5px solid #999; }
        .step.success { background: #d1fae5; border-left: 5px solid #10b981; color: #065f46; }
        .step.error { background: #fee2e2; border-left: 5px solid #ef4444; color: #991b1b; }
        .status-icon { font-weight: bold; }
        #errorMsg { margin-top: 20px; padding: 15px; background: #2d3748; color: #fc8181; border-radius: 5px; font-family: monospace; white-space: pre-wrap; display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ› ï¸ è®ºå›è¿æ¥è¯Šæ–­å™¨</h2>
        <p>è¯·ç­‰å¾…ç¨‹åºè‡ªåŠ¨æ£€æµ‹...</p>

        <div id="step1" class="step pending"><span>1. åˆå§‹åŒ– Firebase é…ç½®</span><span class="status-icon">â³</span></div>
        <div id="step2" class="step pending"><span>2. æµ‹è¯•åŒ¿åç™»å½• (Auth)</span><span class="status-icon">â³</span></div>
        <div id="step3" class="step pending"><span>3. è¿æ¥æ•°æ®åº“ (Firestore)</span><span class="status-icon">â³</span></div>
        <div id="step4" class="step pending"><span>4. å°è¯•å†™å…¥ä¸€æ¡æµ‹è¯•æ•°æ®</span><span class="status-icon">â³</span></div>

        <div id="errorMsg"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // ä½ çš„é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBzVD0XuA8Vw-e-7lKEx3K69UCe6lkDhFQ",
            authDomain: "coffee-spark-ai-barista-8b0e2.firebaseapp.com",
            projectId: "coffee-spark-ai-barista-8b0e2",
            storageBucket: "coffee-spark-ai-barista-8b0e2.firebasestorage.app",
            messagingSenderId: "732057248424",
            appId: "1:732057248424:web:cd43ba3f2d87cc58f3989d"
        };

        const updateStep = (id, status, msg = '') => {
            const el = document.getElementById(id);
            if (status === 'success') {
                el.className = 'step success';
                el.querySelector('.status-icon').textContent = 'âœ… æˆåŠŸ';
            } else if (status === 'error') {
                el.className = 'step error';
                el.querySelector('.status-icon').textContent = 'âŒ å¤±è´¥';
                const errBox = document.getElementById('errorMsg');
                errBox.style.display = 'block';
                errBox.textContent = `é”™è¯¯è¯¦æƒ… (è¯·æŠŠè¿™ä¸ªå‘ç»™æˆ‘):\n\n${msg}`;
                throw new Error('Stop'); // åœæ­¢åç»­æ­¥éª¤
            }
        };

        async function runDiagnosis() {
            try {
                // 1. åˆå§‹åŒ–
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                updateStep('step1', 'success');

                // 2. ç™»å½•
                try {
                    await signInAnonymously(auth);
                    updateStep('step2', 'success');
                } catch (e) {
                    updateStep('step2', 'error', `ç™»å½•å¤±è´¥: ${e.code}\n${e.message}\n\nğŸ‘‰ è§£å†³æ–¹æ³•: è¯·å» Firebase æ§åˆ¶å° -> Authentication -> Sign-in methodï¼ŒæŠŠ "Anonymous" å¼€å…³æ‰“å¼€ã€‚`);
                }

                // 3. è¿æ¥æ•°æ®åº“
                updateStep('step3', 'success');

                // 4. å†™å…¥æµ‹è¯•
                try {
                    await addDoc(collection(db, 'debug_tests'), {
                        time: new Date().toISOString(),
                        test: 'connection_check'
                    });
                    updateStep('step4', 'success');
                    alert("ğŸ‰ æ­å–œï¼è¿æ¥å®Œå…¨æ­£å¸¸ï¼ç°åœ¨ä½ å¯ä»¥å»è¿è¡Œ index.html äº†ï¼");
                } catch (e) {
                    let tip = "æœªçŸ¥é”™è¯¯";
                    if (e.message.includes("permission-denied") || e.message.includes("Missing or insufficient permissions")) {
                        tip = "ğŸ‘‰ è§£å†³æ–¹æ³•: æ•°æ®åº“æƒé™è¢«æ‹’ç»ã€‚\nè¯·å» Firebase æ§åˆ¶å° -> Firestore Database -> Rulesï¼ŒæŠŠè§„åˆ™æ”¹æˆ allow read, write: if true;";
                    } else if (e.code === "unimplemented" || e.message.includes("NOT_FOUND")) {
                         tip = "ğŸ‘‰ è§£å†³æ–¹æ³•: ä½ å¯èƒ½åˆ›å»ºäº†é¡¹ç›®ï¼Œä½†ã€æ²¡æœ‰åˆ›å»ºæ•°æ®åº“ã€‘ã€‚\nè¯·å» Firebase æ§åˆ¶å° -> Build -> Firestore Databaseï¼Œç‚¹å‡» 'Create Database'ã€‚";
                    }
                    updateStep('step4', 'error', `å†™å…¥å¤±è´¥: ${e.code}\n${e.message}\n\n${tip}`);
                }

            } catch (err) {
                if (err.message !== 'Stop') console.error(err);
            }
        }

        runDiagnosis();
    </script>
</body>
</html>